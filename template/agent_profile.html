{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile - SideCrew{% endblock %}

{% block styles %}
<style>
    .file-input-label {
        cursor: pointer;
    }
    .file-input-hidden {
        display: none;
    }
    /* Give the map a defined height */
    .leaflet-container {
        height: 400px;
        width: 100%;
        border-radius: 0.5rem; /* 8px */
        border: 1px solid #cbd5e1; /* slate-300 */
    }
</style>
{% endblock %}


{% block content %}

    <section class="py-20 bg-slate-100">
        <div class="container mx-auto px-6 max-w-4xl">

            <div class="text-center mb-12">
                <div class="inline-flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-blue-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800">My Profile</h2>
                </div>
                <p class="mt-4 text-lg text-slate-600">
                    View and update your account details.
                </p>
            </div>

            {% if messages %}
                <div class="mb-6">
                    {% for message in messages %}
                        <div class="p-4 rounded-md text-sm {% if message.tags == 'error' %} bg-red-100 border border-red-400 text-red-700 {% else %} bg-green-100 border border-green-400 text-green-700 {% endif %}" role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="bg-white rounded-lg shadow-xl overflow-hidden">

                    <div class="p-6 md:p-10">

                        <div class="md:flex items-center gap-8 mb-8">
                            {% if agent.profile_pic %}
                                <img src="{{ agent.profile_pic.url }}" alt="{{ agent.name }}'s profile picture"
                                     class="w-32 h-32 rounded-full mx-auto md:mx-0 object-cover mb-4 md:mb-0 ring-4 ring-blue-100 p-1">
                            {% else %}
                                <div class="w-32 h-32 rounded-full mx-auto md:mx-0 bg-slate-200 flex items-center justify-center text-slate-500 mb-4 md:mb-0 text-sm font-medium ring-4 ring-slate-200">
                                    No Photo
                                </div>
                            {% endif %}

                            <div class="text-center md:text-left flex-1">
                                <div class="flex items-center gap-2 text-center md:text-left">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-slate-700">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.04l-.821 1.316z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
                                    </svg>
                                    <h3 class="text-lg font-semibold text-slate-800">Change Profile Picture</h3>
                                </div>
                                <p class="text-sm text-slate-500 mt-1 mb-4">Upload a new photo for your profile (max 2MB).</p>

                                <label for="profile_pic" class="file-input-label inline-flex items-center gap-2 bg-blue-50 text-blue-700 hover:bg-blue-100 font-semibold py-2 px-4 rounded-md text-sm transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                        <path d="M10.75 4.75a.75.75 0 00-1.5 0v8.614L6.295 10.23a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 10-1.09-1.03l-2.955 3.134V4.75z" />
                                        <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                                    </svg>
                                    <span>Choose a file</span>
                                </label>
                                <input type="file" name="profile_pic" id="profile_pic" class="file-input-hidden" accept="image/*">
                            </div>
                        </div>

                        <hr class="border-slate-200 my-8">

                        <h3 class="text-xl font-semibold text-slate-800 mb-6">Account Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                            <div>
                                <label for="name" class="block text-sm font-medium text-slate-700">Full Name</label>
                                <input type="text" name="name" id="name" value="{{ agent.name }}"
                                       class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pl-4">
                            </div>

                            <div>
                                <label for="agency_name" class="block text-sm font-medium text-slate-700">Agency Name</label>
                                <input type="text" name="agency_name" id="agency_name" value="{{ agent.agency_name }}"
                                       class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pl-4">
                            </div>

                            <div>
                                <label for="email" class="block text-sm font-medium text-slate-700">Email Address</label>
                                <input type="email" name="email" id="email" value="{{ agent.email }}"
                                       class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pl-4">
                            </div>

                            <div>
                                <label for="phone" class="block text-sm font-medium text-slate-700">Phone Number</label>
                                <input type="tel" name="phone" id="phone" value="{{ agent.phone }}"
                                       class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pl-4">
                            </div>

                            <div class="md:col-span-2">
                                <label for="address" class="block text-sm font-medium text-slate-700">Address</label>
                                <textarea name="address" id="id_address" rows="3"
                                          class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pl-4 pt-2 bg-slate-50"
                                          readonly>{{ agent.address }}</textarea>
                                <p class="text-xs text-slate-500 mt-1">Your address is automatically updated when you set your location on the map below.</p>
                            </div>
                        </div>

                        <hr class="border-slate-200 my-8">

                        <h3 class="text-xl font-semibold text-slate-800 mb-6">Update Your Location</h3>
                        <p class="text-sm text-slate-600 mb-4">Click on the map to set or update your agency's pin. This location is used to show you to nearby clients.</p>

                        <div id="map" class="leaflet-container"></div>

                        <input type="hidden" name="latitude" id="id_latitude" value="{{ agent.latitude|default_if_none:'' }}">
                        <input type="hidden" name="longitude" id="id_longitude" value="{{ agent.longitude|default_if_none:'' }}">
                        </div>

                    <div class="bg-slate-50 p-6 border-t border-slate-200 flex flex-col-reverse sm:flex-row sm:justify-between sm:items-center gap-4">
                        <a href="{% url 'delete_agent_profile' %}"
                           class="w-full sm:w-auto text-center bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 px-5 rounded-md text-sm transition-colors flex items-center justify-center gap-2"
                           onclick="return confirm('Are you sure you want to permanently delete your profile? This action cannot be undone.')">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.839 0 1.67.017 2.5.051v-.301A1.25 1.25 0 0011.25 2.5h-2.5A1.25 1.25 0 007.5 3.75v.3c.83.034 1.661.051 2.5.051zM8.293 8.293a1 1 0 011.414 0L10 8.586l.293-.293a1 1 0 111.414 1.414L11.414 10l.293.293a1 1 0 01-1.414 1.414L10 11.414l-.293.293a1 1 0 01-1.414-1.414L8.586 10l-.293-.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                           </svg>
                           <span>Delete Profile</span>
                        </a>

                        <button type="submit"
                                class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-md text-sm transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                            </svg>
                            <span>Save Changes</span>
                        </button>
                    </div>

                </div>
            </form>

        </div>
    </section>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Get references to the hidden form fields
    const addressInput = document.getElementById('id_address');
    const latInput = document.getElementById('id_latitude');
    const lngInput = document.getElementById('id_longitude');

    // --- NEW: Read initial location from the form ---
    // Use default (Kozhikode) if no location is set
    const initialLat = parseFloat(latInput.value) || 11.2588;
    const initialLng = parseFloat(lngInput.value) || 75.7804;
    const hasInitialLocation = !!(latInput.value && lngInput.value);

    // 1. Initialize the map
    const map = L.map('map').setView([initialLat, initialLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let marker;

    // --- NEW: Place the marker on load if location exists ---
    if (hasInitialLocation) {
        marker = L.marker([initialLat, initialLng]).addTo(map);
    }

    // 2. Handle map click
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        // Add/move the marker
        if (marker) {
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng).addTo(map);
        }

        // Fill the hidden lat/lng fields
        latInput.value = lat.toFixed(7);
        lngInput.value = lng.toFixed(7);

        // 3. Reverse Geocoding
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const address = data.display_name || 'Address not found';
                // Update the *readonly* address textarea
                addressInput.value = address;
            })
            .catch(err => {
                console.log('Error fetching address:', err);
                addressInput.value = 'Could not find address. Please try again.';
            });
    });
});
</script>
{% endblock %}